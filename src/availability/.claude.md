# Availability Module

This module handles the core logic for determining item availability based on prerequisite dependencies in checklists.

## Purpose

The availability system parses prerequisite expressions (like "OPTION Choice", "USES 3x Potion", "MISSED Boss Fight") and generates Google Sheets formulas that dynamically calculate whether each item is available, missed, or blocked based on the checklist state.

## Key Components

### Main Classes

**StatusFormulaTranslator** (`StatusFormulaTranslator.ts`)
- Main orchestrator for formula generation
- Singleton pattern: Retrieved via `StatusFormulaTranslator.fromChecklist(checklist)`
- Manages parsing phases: BUILDING → FINALIZING → FINALIZED
- Coordinates CellFormulaParser instances for each row
- Generates final status formulas and hyperlinks

**CellFormulaParser** (`CellFormulaParser.ts`)
- Parses prerequisites for a single checklist row
- Builds formula AST (Abstract Syntax Tree) using node classes
- Handles circular dependency detection
- Singleton pattern per row: Retrieved via `CellFormulaParser.getParserForChecklistRow(translator, row)`

### Supporting Files

**types.ts** - Basic type aliases
- `row`, `column` - Spreadsheet coordinates
- `Range`, `RichTextValue` - Google Apps Script types
- `FormulaHelper` - Interface for formula generation helpers

**interfaces.ts** - Complex types and interfaces
- `IStatusFormulaTranslator` - Interface for breaking circular dependencies
- `RowCounts` - Tracks counts of items by row
- `NodeArgs` - Arguments for creating formula nodes

**constants.ts** - Enums and static values
- `SPECIAL_PREFIXES` - Keywords like USES, MISSED, OPTION, BLOCKS, etc.
- `PHASE` - Build phases: BUILDING, FINALIZING, FINALIZED
- `USAGES` - Help text for special syntax

**utilities/** - Helper functions
- `formula-helpers.ts` - Formula builders (AND, OR, NOT, VALUE, etc.)
- `parser-utilities.ts` - Text parsing utilities, escape handling
- `translator-helpers.ts` - Convenience functions for getting translators

### Node System

The `nodes/` directory contains formula AST node classes organized by purpose. See `nodes/.claude.md` for details.

## How It Works

### Formula Generation Flow

1. **Initialize**: `StatusFormulaTranslator.fromChecklist(checklist)` creates translator
2. **Parse** (BUILDING phase): Create `CellFormulaParser` for each row, parse prerequisites into node trees
3. **Finalize** (FINALIZING phase): Resolve virtual items, calculate dependencies, detect circles
4. **Generate** (FINALIZED phase): Convert node trees to Google Sheets formulas
5. **Output**: Write formulas to Available column, add hyperlinks to Pre-Reqs column

### Example Prerequisite Parsing

```
"Quest A AND Quest B"  →  BooleanFormulaNode(AND) with two BooleanFormulaValueNode children
"USES 3x Potion"       →  UsesFormulaNode tracking consumable usage
"OPTION Choice1"       →  OptionFormulaNode for mutually exclusive choices
"MISSED Path A"        →  MissedFormulaNode marking mutual exclusivity
```

### Status Formula Output

Generated formulas use nested IFS() to check status in order:
1. ERROR - Formula calculation error
2. CHECKED - Item completed
3. MISSED - Item permanently unavailable
4. UNKNOWN - Circular dependency
5. PR_USED - Prerequisites consumed by other items
6. AVAILABLE - All prerequisites met
7. PR_NOT_MET - Prerequisites not yet completed

## Design Patterns

- **Singleton**: CellFormulaParser and StatusFormulaTranslator cached by identity
- **Builder**: Node classes build formula strings fluently
- **Visitor**: Node tree traversal for formula generation
- **Phase-based construction**: Three-phase build process prevents premature operations

## Common Operations

**Generate formulas for entire checklist:**
```typescript
const translator = StatusFormulaTranslator.fromChecklist(checklist);
translator.validateAndGenerateStatusFormulas();
```

**Add hyperlinks to prerequisites:**
```typescript
const translator = StatusFormulaTranslator.fromChecklist(checklist);
translator.addLinksToPreReqsInRange(startRow, endRow);
```

**Parse a single cell's prerequisites:**
```typescript
const parser = CellFormulaParser.getParserForChecklistRow(translator, row);
const rootNode = parser.getRootNode();
const formula = rootNode.toStatusFormula();
```

## Performance Considerations

- Formulas generated in phases to allow optimization
- Circular dependency detection uses memoization
- Virtual items tracked globally for efficiency
- Large checklists (1000+ rows) may take several seconds to process

## Future Improvements

- Interactive validation UI for common errors
- Better multi-row item linking
- Performance optimization for very large checklists
- Incremental formula updates (instead of full regeneration)
