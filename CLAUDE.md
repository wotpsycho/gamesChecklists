# Games Checklists - Claude Context

## Overview

**Games Checklists** is a Google Apps Script-based interactive checklist application designed for tracking complex tasks with prerequisite dependencies. Originally created to track video game completions (achievements, side quests, collectibles), it features dynamic availability tracking, hierarchical metadata, conditional formatting, and customizable filtering.

**Live Demo**: https://docs.google.com/spreadsheets/d/1AwFklc_45IzYA6WjUxCa3H6QuOnpHbW_59fGcG8Sb9A/edit?usp=sharing

## Technology Stack

- **Language**: TypeScript (compiled to Google Apps Script)
- **Runtime**: Google Apps Script (JavaScript V8)
- **Platform**: Google Sheets
- **Module System**: ES6 modules (bundled with Rollup)
- **Bundler**: Rollup with TypeScript plugin
- **Deployment**: clasp (Command Line Apps Script Projects) with custom multi-target deployment
- **Package Manager**: npm

## Core Concepts

### Checklist Structure

Each checklist is a Google Sheet with the following row types:

1. **TITLE** - Displays checklist title and aggregate statistics
2. **SETTINGS** - Interactive settings row with dropdowns for view modes and actions
3. **QUICK_FILTER** (optional) - Row for filtering columns with regex or dropdown selection
4. **HEADERS** - Column headers defining the checklist structure
5. **Data Rows** - Individual checklist items

### Standard Columns

- **✓ (CHECK)** - Checkbox column for marking items complete
- **Type** - Categorizes items (Quest, Achievement, Collectible, etc.)
- **Item** - The item name/description
- **Pre-Reqs** - Newline-separated list of prerequisite items that must be completed first
- **Notes** - Additional information or warnings
- **Available** (hidden) - Formula-calculated status column

### Item Status States

- **CHECKED** - Item completed (checked off)
- **AVAILABLE** - Item ready to complete (all pre-reqs met)
- **PR_NOT_MET** - Prerequisites not yet completed
- **MISSED** - Item permanently unavailable due to conflicting choice
- **PR_USED** - Item skipped/not chosen when alternative was selected, or too many prerequisites have been used by other items
- **UNKNOWN** - Circular dependency, availability uncertain
- **ERROR** - Formula calculation error

### Metadata System

The **Meta Sheet** is a companion sheet that defines:

- **Value Lists**: Valid values for dropdown columns (Type, custom metadata)
- **Formatting Rules**: Cell colors, fonts, styles applied based on values
- **Parent Hierarchies**: Multi-level categorization using `PARENT(ColumnName)` syntax
- **Links & Notes**: Rich text links and hover notes for metadata values
- **Auto-sync**: New values in checklist automatically added to meta sheet

Meta columns can format multiple checklist columns using syntax: `ColumnName[AdditionalColumn1, AdditionalColumn2]`

### Prerequisites System

The Pre-Reqs column supports advanced dependency logic with special keywords, operators, and patterns. See `tools/sheets-cli/PREREQ_PATTERNS.md` for comprehensive documentation with real examples.

#### Core Features

- **Auto-Generated Formulas**: Complex status formulas automatically generated from Pre-Reqs text
- **Dynamic Updates**: Formulas recalculate in real-time as items are checked
- **Hyperlinked References**: Pre-req item names become clickable links to their rows
- **Error Detection**: Validates circular dependencies, missing items, and invalid patterns
- **Multi-line Support**: Pre-reqs can span multiple lines for readability

#### Special Keywords

**LINKED** - Parent-child relationships
- Creates header items that track multiple sub-tasks
- Header checkbox auto-calculated based on children
- Syntax: `LINKED [item pattern]`
- Example: `LINKED S.1-*` (tracks all items starting with S.1-)

**USES** - Consumable resource tracking
- Tracks items used across multiple checklist items
- Prevents over-consumption of limited resources
- Syntax: `USES [number]x [item]` or `USES [item] [number]`
- Example: `USES *Enthusiasm 1` (uses 1 Enthusiasm from any source)
- Real use case: Heart pieces used to restore character emotions

**OPTION** - Mutually exclusive choices
- Only one option from a group can be selected
- Checking one marks others as PR_USED
- Syntax: `OPTION [Choice ID]`
- Example: Three familiars with `OPTION Serenade a Familiar`
- Use cases: Character recruitment, story branches, reward selection

**MISSED** - Mutual exclusivity
- Makes referenced item permanently unavailable
- Creates "either/or" scenarios
- Syntax: `MISSED [item name]`
- Example: `MISSED Kill Boss` vs `MISSED Spare Boss`

**BLOCKS** - Temporary item blocking
- Blocks items from becoming available until condition met
- Supports complex filtering by column values
- Syntax: `BLOCKS [pattern] UNTIL [condition]`
- Example: `BLOCKS Area=Dungeon UNTIL Get Key`
- Advanced: `BLOCKS UNLESS (Area=City|Town) UNTIL Chapter 3`

**BLOCKED** - Explicit item blocking
- Usually auto-generated by BLOCKS statements
- Can be used manually for specific blocking
- Syntax: `BLOCKED [condition] UNTIL [unblock condition]`

**PERSIST** - Persistent items
- Item remains checked through checklist resets
- Use for permanent unlocks or one-time achievements
- Must be on its own line

**CHECKED/INITIAL** - Initially checked items
- Item starts in checked state
- Use for default states or tutorial completions
- Must be on its own line

**OPTIONAL** - Optional prerequisites
- Marks prerequisites as optional enhancements
- Syntax: `OPTIONAL [prerequisites]`

#### Boolean Operators

- **AND**: Multiple items on separate lines (implicit), or explicit `Item A AND Item B`
- **OR**: Alternative prerequisites, `Item A OR Item B`
- **NOT**: Negation, `NOT Item A` or `!Item A`
- **Parentheses**: Grouping, `(Item A OR Item B) AND Item C`

#### Comparison Operators

- **GT/GTE**: Greater than, `Level GT 10`
- **LT/LTE**: Less than, `Level LT 20`
- **EQ**: Equals, `Chapter EQ 5`
- **NE**: Not equals, `Chapter NE 1`
- **Count**: Item count, `3x Quest*` (requires 3 quests)

#### Advanced Patterns

**Wildcard Matching**:
- `*` matches any characters
- `Quest*` matches "Quest 1", "Quest 2", etc.
- `H.1:*` matches "H.1: Step 1", "H.1: Step 2", etc.

**Row References**:
- `$[row]` references item by row number
- Useful for dynamic references

**Column Filters** (used with BLOCKS):
- `Column=Value` - Exact match
- `Column=Value1|Value2` - OR match
- `Column=Value*` - Wildcard match
- `Column!Value` - NOT match
- `EXCEPT Column=Value` - Exception filter
- `WITH Column=Value` - Additional filter

**Multi-line Continuation**:
- Use `...` to continue a long statement on the next line
- Example:
  ```
  BLOCKS
  ... UNLESS (Area=Hamelin|Pig Iron Plain)
  ... UNLESS Region=""
  ... UNTIL Restore Belief
  ```

#### Real-World Example Combinations

**Multi-Step Quest with LINKED:**
```
Item: "S.3-4: A Nationwide Scandal"
Pre-Reqs: "LINKED
Check Lady Luck Statue
Talk with Niall
Search for Evidence
Mossy Monument
Confront Master Pugnacius"
```

**Resource Management with USES:**
```
Item: "Restore Guard's Enthusiasm"
Pre-Reqs: "USES *Enthusiasm 1"

Item: "Restore King Tom's Enthusiasm"
Pre-Reqs: "USES *Enthusiasm 2"
```

**Story Gating with BLOCKS:**
```
Item: "Board Sea Cow"
Pre-Reqs: "Board Sea Cow
BLOCKS UNLESS Region=Teeheeti|\"\" UNLESS Location=*Evolve* UNTIL Board Repaired Sea Cow"
```

**Mutually Exclusive Choices with OPTION:**
```
Item: "Shonky-Honker"
Pre-Reqs: "OPTION Serenade a Familiar"

Item: "Boggly-Boo"
Pre-Reqs: "OPTION Serenade a Familiar"

Item: "Lagoon Naiad"
Pre-Reqs: "OPTION Serenade a Familiar"
```

The status formulas are automatically generated and dynamically update as items are checked. See implementation in `src/availability/` directory.

## Architecture

### File Naming Convention

The project uses the following file naming convention:

**Root `src/` directory:**
- Files follow kebab-case (e.g., `index.ts`, `util.ts`)
- Exception: Class-containing files use PascalCase (e.g., `SheetBase.ts`, `ChecklistApp.ts`)

**`src/availability/` directory and subdirectories:**
- Files containing a single class → PascalCase matching the class name (e.g., `BooleanFormulaNode.ts`)
- Files with multiple classes → PascalCase of the "main" class
- Non-class files (utilities, types, registries) → kebab-case (e.g., `types.ts`, `registries.ts`, `index.ts`)

This convention improves discoverability: seeing `BooleanFormulaNode.ts` immediately indicates it contains the `BooleanFormulaNode` class.

### Module Organization

The codebase uses ES6 modules bundled via Rollup into a single IIFE for Google Apps Script:

- **ChecklistApp** - Core checklist logic and Checklist class
- **ChecklistMeta** - Metadata sheet management
- **Settings** - Settings system and UI controls
- **Status** - Status formula generation and validation
- **Formula** - Formula building utilities with pretty-printing

Modules are imported in `src/index.ts` and bundled to `build/Code.js` with top-level function declarations for Apps Script compatibility.

### Key Classes

#### SheetBase (ChecklistApp.SheetBase)
Base class providing common sheet operations:
- Range manipulation (getRange, getColumnDataRange, etc.)
- Value read/write operations
- Filter management
- Row/column helpers
- Column-by-header lookup

#### Checklist (ChecklistApp.Checklist)
Main checklist controller extending SheetBase:
- Event handlers (onOpen, onEdit, onChange)
- Structure management (ensure columns/rows exist)
- Data validation setup
- Conditional formatting rules
- Filter operations
- Reset/refresh operations
- Settings integration
- Meta sheet synchronization

Singleton pattern: Retrieved via `Checklist.fromSheet(sheet)` or `Checklist.fromEvent(event)`

#### MetaSheet (ChecklistMeta.MetaSheet)
Metadata sheet manager:
- Parses meta columns and values
- Tracks parent/child hierarchies
- Syncs formatting to checklist
- Generates data validation dropdowns
- Manages conditional formatting rules
- Updates links and notes

Singleton pattern: Retrieved via `MetaSheet.fromChecklist(checklist)`

#### ChecklistSettings (Settings.ChecklistSettings)
Settings manager:
- View mode (All, Available, Condensed, Remaining, Completed, Missed)
- Column visibility (Notes, Pre-Reqs, Blanks)
- Editing mode toggle
- Quick Filter toggle
- Actions (Refresh, Reset, Sync Meta)

### Event Flow

**onOpen**:
1. Populate settings dropdowns
2. Ensure total formulas exist

**onEditSimple** (fires first, faster):
1. Check for quick checkbox toggle optimization
2. Handle quick filter changes
3. Handle settings changes (left side only)
4. Mark edited cells

**onEditInstallable** (fires second, more powerful):
1. Handle debug commands (A1 cell hacks)
2. Handle settings changes (right side)
3. Sync notes from Notes column to Item column
4. Handle meta sheet edits

**onChangeSimple**:
1. Ensure filter size matches sheet size after insertions

## File Structure

```
/
├── src/
│   ├── index.ts                    # Entry point, exports all modules
│   ├── appsscript.json             # Apps Script manifest
│   ├── util.ts                     # Timing utilities
│   ├── Formulas.ts                 # Formula builder with pretty-print
│   ├── SheetBase.ts                # Base class for sheet operations
│   ├── ChecklistApp.ts             # Main checklist logic
│   ├── ChecklistMeta.ts            # Metadata system
│   ├── ChecklistSettings.ts        # Settings system
│   ├── StatusFormulaTranslator.ts  # Pre-req formula generation
│   ├── Triggers.ts                 # Event trigger management
│   └── Reset.ts                    # Global reset functions
├── scripts/
│   ├── clasp-deploy.js             # Multi-target deployment tool
│   └── watch-push.js               # Watch mode with auto-push
├── build/                          # Generated output (git-ignored)
│   ├── Code.js                     # Bundled output
│   └── appsscript.json             # Copied manifest
├── rollup.config.js                # Rollup bundler configuration
├── tsconfig.json                   # TypeScript configuration
├── package.json                    # npm dependencies and scripts
├── DEPLOYMENT.md                   # Deployment system documentation
└── CLAUDE.md                       # This file
```

## Key Features

### Dynamic Filtering
- Filter by status (Available, Completed, Missed, etc.)
- Quick Filter row with regex or dropdown-based filtering
- Quick Filter supports parent/child hierarchy matching
- Hide completed items, blanks, or unavailable items

### Conditional Formatting
Color-coded visual feedback:
- Green: Checked/completed items
- Orange: Prerequisites not met
- Red: Missed items
- Purple: Not chosen (alternative selected)
- Gray: Disabled checkboxes
- Dark red background: Missable items (MISSED pre-req)
- Blue/Red text: INFO/WARN notes
- Custom colors from Meta sheet

### Formula Generation
Complex status formulas automatically generated from Pre-Reqs:
- Parses logical expressions (AND, OR, NOT)
- Handles mutual exclusivity (MISSED)
- Creates hyperlinks to prerequisite items
- Validates circular dependencies
- Updates dynamically as items are checked

### Metadata Hierarchy
PARENT() system allows multi-level categorization:
```
Type Column:        PARENT(Type):
Quest               (no parent)
Main Quest          Quest
Side Quest          Quest
Optional            (no parent)
```
Child values inherit parent formatting and are matched by Quick Filters.

### Performance Optimizations
- Caching system for frequently accessed data
- Request ID tracking to prevent stale operations
- Short-circuit evaluation for common edits
- Parallel formula evaluation where possible
- Timing instrumentation throughout

### Protection & Validation
- Sheet protection with editable ranges
- Data validation for dropdowns
- Duplicate item name detection
- Pre-req validation (items must exist)
- Formula validation to catch errors

### Reporting
Title cell displays real-time statistics:
```
R: 15/20      (Remaining: 15 available / 20 total remaining)
C: 45/50      (Completed: 45 checked / 50 total)
90%           (Completion percentage)
```

Pre-Reqs cell shows counts:
```
Missed: 2
Not Chosen: 3
Unknown: 1
```

## Development Workflow

### Setup
1. Install dependencies: `npm install`
2. Install clasp globally: `npm install -g @google/clasp`
3. Login to clasp: `clasp login`
4. Configure deployment targets (see Deployment section below)

### Build
```bash
npm run build          # Build TypeScript → bundled output
```

### Development
```bash
npm run watch          # Watch mode, auto-rebuild on changes
npm run watch:push     # Watch + auto-push to selected target
```

### Deployment

The project uses a custom multi-target deployment system that allows pushing to multiple Google Sheets from a single codebase.

**Quick start:**
```bash
npm run push           # Interactive: select target and push
npm run push:add       # Add a new deployment target
npm run push:list      # List all configured targets
npm run push:all       # Push to all targets
```

**Configuration:**
Deployment targets are stored in `.clasp.local.json` (git-ignored). Each target represents a different Google Sheet using this Apps Script code.

**See DEPLOYMENT.md for comprehensive documentation** including:
- Setting up deployment targets
- Managing multiple sheets
- Watch mode with auto-push
- Troubleshooting

### Local Development
1. Edit TypeScript files in `/src`
2. Run `npm run build` or `npm run watch` to compile
3. Use `npm run push` to deploy to your target sheet
4. Changes appear immediately in the live Google Sheet

## Common Operations

### Initializing a New Checklist
1. Create data with Item column
2. Add Type, Pre-Reqs, Notes columns as needed
3. Type "reset" in A1 cell to initialize structure
4. Use Settings > Action > "Sync Meta" to create meta sheet

### Creating Meta Sheet
1. Settings > Action > "Toggle Quick Filter" (if desired)
2. Menu: Add-ons > Games Checklist > Create Meta Sheet
3. Add values to meta columns for each checklist column
4. Format meta values (colors, fonts) as desired
5. Use "Sync Meta" action to apply to checklist

### Adding Parent Hierarchies
1. In Meta sheet, add column header: `PARENT(ExistingColumn)`
2. Fill parent values for each child value
3. Sync meta to apply
4. Quick Filters will now match parent + all children

### Resetting Checklist
Type in A1:
- `refresh` - Refresh structure and formulas (keep checkboxes)
- `reset` - Reset structure (prompt to clear checkboxes)
- `FULL RESET` - Full reset including clearing all checkboxes
- `status` - Regenerate status formulas only
- `meta` - Sync meta sheet
- `link` - Regenerate pre-req hyperlinks

## Design Patterns

### Singleton Pattern
Checklists and MetaSheets are cached by sheet ID to prevent duplicate instances and state conflicts.

### Lazy Loading
Properties like `meta`, `filter`, `columnsByHeader` are computed on first access and cached.

### Builder Pattern
Formula class provides fluent API for building complex formulas with automatic pretty-printing.

### Observer Pattern
Event handlers propagate changes through the system (edit -> validation -> formatting -> filtering).

## Known Limitations

- **Apps Script Runtime Constraints** - Google Apps Script has execution time limits (6 minutes for triggers) and doesn't natively support ES6 modules. This project uses Rollup to bundle ES6 modules into an IIFE that Apps Script can execute.
- **Large Checklists** - Checklists with 1000+ rows may be slow to initialize due to formula generation and conditional formatting
- **Formula Recalculation** - Formula recalculation happens on Google's servers and can lag for complex dependencies
- **Permissions** - Users must grant script permissions for full functionality (sheet access, triggers)
- **Private Project** - Currently a personal project, not production-ready for public use

## Future Considerations

- Better error handling and user feedback
- Performance optimization for large checklists
- Public release with simplified setup
- Documentation and usage guide
- Test coverage
- Migration to Google Sheets add-on format

## Tips for Working with This Codebase

1. **Read SheetBase first** - Understanding the base class is key to understanding Checklist
2. **Formula class is your friend** - Use it for any formula generation to ensure correctness
3. **Always check if filter exists** - Remove before bulk operations, recreate after
4. **Respect the singleton pattern** - Use `Checklist.fromSheet()`, don't call constructor
5. **Use timing functions** - `time(label)` and `timeEnd(label)` for performance tracking
6. **Metadata invalidates caches** - Many properties are cached, metadata changes require sync
7. **Test with small checklists first** - Apps Script timeout is real
8. **A1 cell is debug console** - Type commands for quick testing

## Example Use Cases

- **RPG Completion**: Track quests, achievements, collectibles with chapter-based filtering
- **Course Curriculum**: Prerequisites for courses, track completion
- **Project Dependencies**: Task tracking with dependency management
- **Recipe Book**: Ingredients as pre-reqs, categorize by meal type
- **Travel Planning**: Activities with seasonal/prerequisite constraints

---

**Status**: Personal project, actively maintained
**License**: Currently UNLICENSED (private/proprietary). May be released publicly in the future with an open-source license.
**Contact**: Via GitHub issues
